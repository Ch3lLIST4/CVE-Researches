// demo 2 - Khai thac AST Injection len pug template engine de RCE
// - thay doi gia tri object qua intercept
// - ung dung thuc hien merge 2 object tai back-end su dung thu vien merge-deep
// - object truyen vao chua thuoc tinh "block.line" dc set RCE payload 


// npm install --save merge-deep
const merge = require('merge-deep');

// npm install --save express
const express = require('express');

// npm install -save pug
const pug = require('pug');


// used to parse HTTP post request body
var bodyParser = require('body-parser');

var app = express();

// create application/json parser
var jsonParser = bodyParser.json();
 
// create application/x-www-form-urlencoded parser
var urlencodedParser = bodyParser.urlencoded({ extended: false });


INDEX_PATH = '/';
MERGE_PATH = '/merge';
TEMPLATE_PATH = '/template';


app.get(INDEX_PATH, function(req, res){
    res.sendFile('./static/index.html', {root: __dirname });
});

app.post(MERGE_PATH, jsonParser, function(req, res){
    
    let source = req.body; 
    let target = {ip:req.socket.remoteAddress};

    result = merge(target, source);
    res.send(result);

});

app.get(TEMPLATE_PATH, function(req, res){

    const template = pug.compile(`h1= msg`);
    res.end(template({msg: 'pug template is working!'}));

});


app.listen(3000);